# ==========================================
#  General Settings
# ==========================================

unbind C-b
set -g prefix C-s
bind C-s send-prefix

set -s escape-time 0
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000

# Enable Extended Keys (CSI u)
set -s extended-keys on
set -as terminal-features 'xterm-256color:extkeys'
set -as terminal-features 'wezterm:extkeys'

if-shell "uname | grep -q Darwin" "set-environment -g PATH '/opt/homebrew/bin:/bin:/usr/bin'"

# ==========================================
# Display & Rendering
# ==========================================

set -g default-terminal "tmux-256color"

# True Color (RGB) Support
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",wezterm:RGB"

# Undercurl Support
set -as terminal-features ",*:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Image Passthrough
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# ==========================================
# Status Bar
# ==========================================

set-option -g status-position top
set -g status-interval 1
set -g status-style bg=default

set -g status-left-length 80
# set -g status-left "\
# #{?client_prefix,#[bg=#bf616a]#[fg=#2e3440] PREFIX ,#[bg=#81a1c1]#[fg=#2e3440] TMUX }\
# #[bg=default]\
# #{?pane_synchronized,#[fg=#ebcb8b] [SYNC],}\
# #{?window_zoomed_flag,#[fg=#bf616a] [Z],}\
# #[fg=#d8dee9] [#S]"
set -g status-left "\
#{?#{==:#{client_key_table},off},#[bg=#bf616a]#[fg=#2e3440] REMOTE (OFF) ,\
#{?client_prefix,#[bg=#ebcb8b]#[fg=#2e3440] PREFIX ,#[bg=#81a1c1]#[fg=#2e3440] TMUX }}\
#[bg=default]\
#{?pane_synchronized,#[fg=#ebcb8b] [SYNC],}\
#{?window_zoomed_flag,#[fg=#bf616a] [Z],}\
#[fg=#d8dee9] [#S]"

set -g window-status-format "#[fg=#4c566a] #I:#W "
set -g window-status-current-format "#[fg=#88c0d0,bold] #I:#W "

set -g status-right-length 150
set -g status-right "\
#[fg=#a3be8c]Git: #(git -C #{pane_current_path} branch --show-current 2>/dev/null || echo '-') \
#[fg=#4c566a] | \
#[fg=#81a1c1]Host: #h \
#[fg=#4c566a] | \
#[fg=#d8dee9]Time: %H:%M "


# ==========================================
# Key Bindings
# ==========================================


# Reload Config: Prefix + Shift + R
bind R source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"
bind -n F2 source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"

# Splits (Keep Path)
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
bind -n F5 split-window -h -c "#{pane_current_path}"
bind -n F6 split-window -v -c "#{pane_current_path}"
bind -n F7 resize-pane -Z
bind -n F8 confirm-before -p "Kill pane #P? (y/n)" kill-pane

# Navigation (Vim)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize (Your Muscle Memory)
# bind -r - resize-pane -D 3
# bind -r = resize-pane -U 3
# bind -r , resize-pane -L 3
# bind -r . resize-pane -R 3

# Window Management
bind d confirm-before -p "kill-window #W? (y/n)" kill-window
bind D detach-client

bind n new-window -c "#{pane_current_path}" # n for New
bind r command-prompt -I "#W" "rename-window '%%'" # r for Rename

# Window Navigation
bind [ previous-window
bind ] next-window
bind Tab last-window

# Tree View
bind o choose-tree -s

# ==========================================
# Copy Mode
# ==========================================

setw -g mode-keys vi

bind / copy-mode
bind -n F10 copy-mode
bind -T copy-mode-vi F10 send-keys -X cancel

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi 'C-v' send -X begin-selection \; send -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection
bind -T copy-mode-vi i send-keys -X cancel
set -g set-clipboard on

unbind p
bind p paste-buffer

# ==========================================
# Transition Mode (Nested Tmux Support)
# ==========================================

bind -T root -n F12 \
  set prefix None \;\
  set key-table off \;\
  refresh-client -S \;\
  display-message "Transparent: ON"

bind -T off -n F12 \
  set prefix C-s \;\
  set key-table root \;\
  set -u status-style \;\
  refresh-client -S \;\
  display-message "Transparent: OFF"


# ==========================================
# Plugins
# ==========================================

set -g @plugin 'tmux-plugins/tpm'

set -g @plugin "arcticicestudio/nord-tmux"
set -g @nord_tmux_no_patched_font "1"

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

set -g @plugin 'mrjones2014/smart-splits.nvim'

bind-key -n C-h if -F '#{@pane-is-vim}' { send-keys C-h } { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind-key -n C-j if -F '#{@pane-is-vim}' { send-keys C-j } { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n C-k if -F '#{@pane-is-vim}' { send-keys C-k } { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind-key -n C-l if -F '#{@pane-is-vim}' { send-keys C-l } { if -F '#{pane_at_right}'  '' 'select-pane -R' }

bind -n M-h if -F "#{@pane-is-vim}" 'send-keys M-h' 'resize-pane -L 2'
bind -n M-j if -F "#{@pane-is-vim}" 'send-keys M-j' 'resize-pane -D 2'
bind -n M-k if -F "#{@pane-is-vim}" 'send-keys M-k' 'resize-pane -U 2'
bind -n M-l if -F "#{@pane-is-vim}" 'send-keys M-l' 'resize-pane -R 2'

bind -T copy-mode-vi 'C-h' select-pane -L
bind -T copy-mode-vi 'C-j' select-pane -D
bind -T copy-mode-vi 'C-k' select-pane -U
bind -T copy-mode-vi 'C-l' select-pane -R


run '~/.tmux/plugins/tpm/tpm'
